#!/usr/bin/env bash
#
# backup script generated by chef for <%= node.fqdn %>
# this script does an on demand backup of
# <%= @c['fqdn'] %>.
#
# DO NOT EDIT - manual edits WILL be lost
#

if [ -f <%= node['rdiff-backup']['cron']['lockfile'] %> ] ; then
  echo "lock file present; aborting backup" >&2
  exit 1
fi

ssh <%= @c['fqdn'] %> 'find <%= node['rdiff-backup']['etc_dir'] %>/pre.d -type f -exec {} \;'
rdiff-backup --print-statistics --remote-schema 'ssh -C %s "sudo /usr/bin/rdiff-backup --server --restrict-read-only /"' <% @c['dirs'].each do |d,w| %> --include <%= d %> <% end %> --exclude / <%= @c['fqdn'] %>::/ <%= node['rdiff-backup']['backup_dir'] %>/<%= @c['fqdn'] %>
ssh <%= @c['fqdn'] %> 'find <%= node['rdiff-backup']['etc_dir'] %>/post.d -type f -exec {} \;'
