#!/usr/bin/env bash
#
# backup script generated by chef for <%= node.fqdn %>
# DO NOT EDIT - manual edits WILL be lost
#
<% @clients.each do |c| 
if c['dirs'] != nil then %>

# <%= c['fqdn'] %>
echo "
starting backup of <%= c['fqdn'] %>
"
ssh <%= c['fqdn'] %> 'find /etc/rdiff-backup/pre.d -type f -exec {} \;'
rdiff-backup --print-statistics <% c['dirs'].each do |d| %> --include <%= d %> <% end %> --exclude / <%= c['fqdn'] %>::/ /backup/<%= c['fqdn'] %>
ssh <%= c['fqdn'] %> 'find /etc/rdiff-backup/post.d -type f -exec {} \;'
<% if node['rdiff-backup']['autotrim_enable'] then %>
rdiff-backup --force --remove-older-than <%= node['rdiff-backup']['autotrim_timespan'] %> <%= node['rdiff-backup']['backup_dir'] %>/<%= c['fqdn'] %>
<% end
end
end %>
